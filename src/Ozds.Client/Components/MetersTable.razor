@using Ozds.Business.Time
@using Ozds.Business.Analysis
@using Ozds.Client.Components.Streaming
@using Color = MudBlazor.Color
@using Size = MudBlazor.Size

@{
  var analyses = RepresentativeState.AnalysisBases.AnalysesByMeasurementLocation();
}

<MudHidden Breakpoint="Breakpoint.MdAndUp">
  <MudText Typo="Typo.h4" Class="d-flex">
    @(Translate("Measurement locations"))
  </MudText>
  @foreach (var analysis in analyses)
  {
    <MudPaper Elevation="2" Class="ma-1">
      <MudStack Spacing="0">
        <MudGrid Class="d-flex pa-2">
          <MudItem xs="8" Class="d-flex align-center justify-start" Style="font-size: large;">
            @Translate("Device"): <br> @(analysis.Meter.Title)
          </MudItem>
          <MudItem xs="2" Class="d-flex align-center justify-end">
            <MudIconButton
              OnClick="@(() => NavigationManager.NavigateTo($"meter/{analysis.Meter.Id}"))"
              Icon="@Icons.Material.Filled.RemoveRedEye" Color="Color.Primary"/>
          </MudItem>
          <MudItem xs="2" Class="d-flex align-center justify-end">
            <MudIconButton
              Icon="@(Icons.Material.Filled.KeyboardArrowDown)" Color="Color.Default"/>
          </MudItem>
        </MudGrid>

        <MudCollapse Class="py-2" Expanded="true">
          <MudStack>
            <MudDivider DividerType="DividerType.Middle" Class="mt-2"/>
            <MudContainer>
              @Translate("Location"): @(analysis.Location.Title)
            </MudContainer>
            @if (analysis.NetworkUser is { } networkUser)
            {
              <MudContainer>
                @Translate("Network user"): @(networkUser.Title)
              </MudContainer>
            }
            <MudContainer Class="d-flex align-center justify-start" Style="font-size: large; font-weight: bold;">
              @Translate("Current months consumption"): <br>
              @NumericString(analysis.Analysis.ThisMonthConsumption.ActiveEnergy_kWh, 0) kWh
            </MudContainer>
            <MudContainer Class="d-flex align-center justify-start" Style="font-size: large; font-weight: bold;">
              @Translate("Last months consumption"): <br>
              @NumericString(analysis.Analysis.LastMonthConsumption.ActiveEnergy_kWh, 0) kWh
            </MudContainer>
            <MudContainer Class="d-flex align-center justify-start" Style="font-size: large; font-weight: bold;">
              @Translate("Last months invoice total"): <br>
              @(analysis.Analysis.LastMonthExpenses.Total_EUR == 0
                ? Translate("Invoice pending...")
                : NumericString(analysis.Analysis.LastMonthExpenses.Total_EUR) + " EUR")
            </MudContainer>
          </MudStack>
        </MudCollapse>
      </MudStack>
    </MudPaper>
  }
</MudHidden>

<MudHidden Breakpoint="Breakpoint.SmAndDown">
  <MudDataGrid
    T="MeasurementLocationAnalysis"
    MultiSelection="true"
    Items="@(analyses)"
    SortMode="SortMode.Multiple"
    Filterable="true"
    QuickFilter="@(x =>
      string.IsNullOrWhiteSpace(_searchString)
      || x.Location.Title.Contains(_searchString)
      || (x.NetworkUser?.Title.Contains(_searchString) ?? false)
      || x.MeasurementLocation.Title.Contains(_searchString)
      || x.Meter.Title.Contains(_searchString))">
    <ToolBarContent>
      <MudText Typo="Typo.h4">@Translate("Measurement locations")</MudText>
      <MudSpacer/>
      <MudTextField
        @bind-Value="_searchString"
        Placeholder="@Translate("Search")"
        Adornment="Adornment.Start"
        Immediate="true"
        AdornmentIcon="@Icons.Material.Filled.Search"
        IconSize="Size.Medium"
        Class="mt-0">
      </MudTextField>
    </ToolBarContent>
    <Columns>

      <TemplateColumn Title="@Translate("Location")" Sortable="false">
        <CellTemplate>
          <MudStack Row>
            <MudButton
              OnClick="@(() => NavigationManager.NavigateTo($"location/{context.Item.Location.Id}"))"
              Variant="Variant.Outlined" Color="Color.Primary">
              @context.Item.Location.Title
            </MudButton>
          </MudStack>
        </CellTemplate>
      </TemplateColumn>

      <TemplateColumn Title="@Translate("Network user")" Sortable="false">
        <CellTemplate>
          @if (context.Item.NetworkUser is { } networkUser)
          {
            <MudStack Row>
              <MudButton
                OnClick="@(() => NavigationManager.NavigateTo($"network-user/{networkUser.Id}"))"
                Variant="Variant.Outlined" Color="Color.Primary">
                @networkUser.Title
              </MudButton>
            </MudStack>
          }
        </CellTemplate>
      </TemplateColumn>

      <TemplateColumn Title="@Translate("Device")" Sortable="false">
        <CellTemplate>
          <MudStack Row>
            <MudButton
              OnClick="@(() => NavigationManager.NavigateTo($"meter/{context.Item.Meter.Id}"))"
              Variant="Variant.Filled" Color="Color.Primary">
              @context.Item.Meter.Title
            </MudButton>
          </MudStack>
        </CellTemplate>
      </TemplateColumn>

      <PropertyColumn
        CellStyle="font-size: x-large;"
        Property="x => x.Analysis.ThisMonthConsumption.ActiveEnergy_kWh"
        Title='@Translate("Current months consumption")'>
        <CellTemplate>
          @(NumericString(context.Item.Analysis.ThisMonthConsumption.ActiveEnergy_kWh, 0)) kWh
        </CellTemplate>
      </PropertyColumn>
      <PropertyColumn
        CellStyle="font-size: x-large;"
        Property="x => x.Analysis.LastMonthConsumption.ActiveEnergy_kWh"
        Title='@Translate("Last months consumption")'>
        <CellTemplate>
          @(NumericString(context.Item.Analysis.LastMonthConsumption.ActiveEnergy_kWh, 0)) kWh
        </CellTemplate>
      </PropertyColumn>
      <PropertyColumn
        CellStyle="font-size: x-large;"
        Property="x => x.Analysis.LastMonthExpenses.Total_EUR"
        Title='@Translate("Last months invoice total")'>
        <CellTemplate>
          @(context.Item.Analysis.LastMonthExpenses.Total_EUR == 0
            ? Translate("Invoice pending...")
            : NumericString(context.Item.Analysis.LastMonthExpenses.Total_EUR) + " EUR")
        </CellTemplate>
      </PropertyColumn>
    </Columns>
    <PagerContent>
      <MudDataGridPager T="MeasurementLocationAnalysis"/>
    </PagerContent>
  </MudDataGrid>
</MudHidden>

@code {
  [CascadingParameter]
  public RepresentativeState RepresentativeState { get; set; } = default!;

  private string? _searchString;
}
