@using MudBlazor
@using System.Linq.Expressions
@using Ozds.Business.Models.Abstractions
@using Ozds.Client.Components.Fields

@* TODO: use .NET 9 OverloadResolutionPriorityAttribute *@

@namespace Ozds.Client.Components.Models.Base

@typeparam TPrefix
@typeparam TModel
@inherits OzdsListModelComponentBase<TPrefix, TModel>

@Base()

@code {
  protected RenderFragment Column<T>(Expression<Func<TModel, T?>> next)
  {
    var label = "";
    if (next.Body is MemberExpression nextMember)
    {
      label = Translate(nextMember.Member.Name);
    }

    return @<PropertyColumn
        T="TPrefix"
        TProperty="T"
        Title='@label'
        Property="@Member(next)" />;
  }

  protected RenderFragment EnumerableColumn<T>(
    Expression<Func<TModel, IEnumerable<T>?>> next
  )
  {
    var label = "";
    if (next.Body is MemberExpression nextMember)
    {
      label = Translate(nextMember.Member.Name);
    }

    var nextFunc = next.Compile();

    return @<PropertyColumn
        T="TPrefix"
        TProperty="IEnumerable<T>"
        Title='@label'
        Property="@Member(next)">
        <CellTemplate>
          @if (Get(nextFunc)(context.Item) is { } item)
          {
            <MudText>
              @string.Join(", ", item)
            </MudText>
          }
        </CellTemplate>
      </PropertyColumn>;
  }

  protected RenderFragment LinkColumn(
    Expression<Func<TModel, IIdentifiable?>> next
  )
  {
    var label = "";
    if (next.Body is MemberExpression nextMember)
    {
      label = Translate(nextMember.Member.Name);
    }

    var nextFunc = next.Compile();

    return @<TemplateColumn T="TPrefix" Title="@label">
        <CellTemplate>
          @if (Get(nextFunc)(context.Item) is { } model)
          {
            <IdentifiableLink Model="model" />
          }
        </CellTemplate>
      </TemplateColumn>;
  }

  protected RenderFragment LinkColumn<T>(
    Expression<Func<TModel, string?>> next
  )
    where T : IIdentifiable
  {
    var label = "";
    if (next.Body is MemberExpression nextMember)
    {
      label = Translate(nextMember.Member.Name);
    }

    var nextFunc = next.Compile();

    return @<TemplateColumn T="TPrefix" Title="@label">
        <CellTemplate>
          @if (Get(nextFunc)(context.Item) is { } id)
          {
            var href = PageHref(Provider.GetPageComponentType(typeof(T)), id);
            <MudLink Href="@href">
              @id
            </MudLink>
          }
        </CellTemplate>
      </TemplateColumn>;
  }
}
