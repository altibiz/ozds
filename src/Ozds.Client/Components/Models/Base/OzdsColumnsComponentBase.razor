@using MudBlazor
@using System.Linq.Expressions
@using System.Collections
@using Ozds.Business.Models.Abstractions
@using Ozds.Client.Components.Fields

@* TODO: use .NET 9 OverloadResolutionPriorityAttribute *@

@namespace Ozds.Client.Components.Models.Base

@typeparam TPrefix
@typeparam TModel
@inherits OzdsListModelComponentBase<TPrefix, TModel>

@Base()

@code {
  protected RenderFragment Column(Expression<Func<TModel, string?>> next)
  {
    var label = "";
    if (next.Body is MemberExpression nextMember)
    {
      label = Translate(nextMember.Member.Name);
    }

    return @<PropertyColumn
        T="TPrefix"
        TProperty="string"
        Title='@label'
        Property="@Member(next)" />;
  }

  protected RenderFragment Column(Expression<Func<TModel, Enum?>> next)
  {
    var label = "";
    if (next.Body is MemberExpression nextMember)
    {
      label = Translate(nextMember.Member.Name);
    }

    return @<PropertyColumn
        T="TPrefix"
        TProperty="Enum"
        Title='@label'
        Property="@Member(next)" />;
  }

  protected RenderFragment Column(Expression<Func<TModel, decimal?>> next)
  {
    var label = "";
    if (next.Body is MemberExpression nextMember)
    {
      label = Translate(nextMember.Member.Name);
    }

    return @<PropertyColumn
        T="TPrefix"
        TProperty="decimal?"
        Title='@label'
        Property="@Member(next)" />;
  }

  protected RenderFragment Column<T>(
    Expression<Func<TModel, IEnumerable<T>?>> next
  )
  {
    var label = "";
    if (next.Body is MemberExpression nextMember)
    {
      label = Translate(nextMember.Member.Name);
    }

    var nextFunc = next.Compile();

    return @<PropertyColumn
        T="TPrefix"
        TProperty="IEnumerable<T>"
        Title='@label'
        Property="@Member(next)">
        <CellTemplate>
          @if (Get(nextFunc)(context.Item) is { } item)
          {
            <MudText>
              @string.Join(", ", item)
            </MudText>
          }
        </CellTemplate>
      </PropertyColumn>;
  }

  protected RenderFragment Column(
    Expression<Func<TModel, DateTimeOffset?>> next
  )
  {
    var label = "";
    if (next.Body is MemberExpression nextMember)
    {
      label = Translate(nextMember.Member.Name);
    }

    var nextFunc = next.Compile();

    return @<PropertyColumn
        T="TPrefix"
        TProperty="DateTimeOffset?"
        Title='@label'
        Property="@Member(next)">
          <CellTemplate>
            <MudText>
              @if (Get(nextFunc)(context.Item) is { } date)
              {
                @DateTimeString(date)
              }
            </MudText>
          </CellTemplate>
        </PropertyColumn>;
  }

  protected RenderFragment EnumerableColumn<T>(
    Expression<Func<TModel, T?>> next
  )
  {
    var label = "";
    if (next.Body is MemberExpression nextMember)
    {
      label = Translate(nextMember.Member.Name);
    }

    var nextFunc = next.Compile();

    return @<PropertyColumn
        T="TPrefix"
        TProperty="T"
        Title='@label'
        Property="@Member(next)">
        <CellTemplate>
          @if (Get(nextFunc)(context.Item) is IEnumerable item)
          {
            <MudText>
              @string.Join(", ", item)
            </MudText>
          }
        </CellTemplate>
      </PropertyColumn>;
  }

  protected RenderFragment TextColumn<T>(Expression<Func<TModel, T?>> next)
  {
    var label = "";
    if (next.Body is MemberExpression nextMember)
    {
      label = Translate(nextMember.Member.Name);
    }

    return @<PropertyColumn
        T="TPrefix"
        TProperty="T"
        Title='@label'
        Property="@Member(next)" />;
  }

  protected RenderFragment EnumColumn<T>(Expression<Func<TModel, T?>> next)
  {
    var label = "";
    if (next.Body is MemberExpression nextMember)
    {
      label = Translate(nextMember.Member.Name);
    }

    return @<PropertyColumn
        T="TPrefix"
        TProperty="T"
        Title='@label'
        Property="@Member(next)" />;
  }

  protected RenderFragment DateColumn<T>(Expression<Func<TModel, T?>> next)
  {
    var label = "";
    if (next.Body is MemberExpression nextMember)
    {
      label = Translate(nextMember.Member.Name);
    }

    var nextFunc = next.Compile();

    return @<PropertyColumn
        T="TPrefix"
        TProperty="T"
        Title='@label'
        Property="@Member(next)">
          <CellTemplate>
            <MudText>
              @if (Get(nextFunc)(context.Item) is DateTimeOffset date)
              {
                @DateString(date)
              }
            </MudText>
          </CellTemplate>
        </PropertyColumn>;
  }

  protected RenderFragment DateTimeColumn<T>(Expression<Func<TModel, T?>> next)
  {
    var label = "";
    if (next.Body is MemberExpression nextMember)
    {
      label = Translate(nextMember.Member.Name);
    }

    var nextFunc = next.Compile();

    return @<PropertyColumn
        T="TPrefix"
        TProperty="T"
        Title='@label'
        Property="@Member(next)">
          <CellTemplate>
            <MudText>
              @if (Get(nextFunc)(context.Item) is DateTimeOffset date)
              {
                @DateTimeString(date)
              }
            </MudText>
          </CellTemplate>
        </PropertyColumn>;
  }

  protected RenderFragment LinkColumn(
    Expression<Func<TModel, IIdentifiable?>> next
  )
  {
    var label = "";
    if (next.Body is MemberExpression nextMember)
    {
      label = Translate(nextMember.Member.Name);
    }

    var nextFunc = next.Compile();

    return @<TemplateColumn T="TPrefix" Title="@label">
        <CellTemplate>
          @if (Get(nextFunc)(context.Item) is { } model)
          {
            <MudLink Href="@(Provider.CreateLink(model))">
              @model.Title
            </MudLink>
          }
        </CellTemplate>
      </TemplateColumn>;
  }

  protected RenderFragment LinkColumn<T>(
    Expression<Func<TModel, string?>> next
  )
    where T : IIdentifiable
  {
    var label = "";
    if (next.Body is MemberExpression nextMember)
    {
      label = Translate(nextMember.Member.Name);
    }

    var nextFunc = next.Compile();

    return @<TemplateColumn T="TPrefix" Title="@label">
        <CellTemplate>
          @if (Get(nextFunc)(context.Item) is { } id)
          {
            var href = PageHref(Provider.GetPageComponentType(typeof(T)), id);
            <MudLink Href="@href">
              @id
            </MudLink>
          }
        </CellTemplate>
      </TemplateColumn>;
  }
}
