@using Ozds.Business.Time
@using Ozds.Business.Analysis
@using Color = MudBlazor.Color
@using Size = MudBlazor.Size

@{
  var analysis = RepresentativeState.AnalysisBases.AnalysisForMeter(Meter.Id);
  if (analysis is null)
  {
    return;
  }
}

<MudHidden Breakpoint="Breakpoint.MdAndUp">
  <MudText Typo="Typo.h4" Class="d-flex">
    @(Translate("Device") + ": " + Meter.Id)
  </MudText>
  <MudText Typo="Typo.h5">@(Translate("Name") + ": " + Meter.Title)</MudText>
  @foreach (var analysis in analysis.Analysis.Monthly)
  {
    <MudPaper Elevation="2" Class="ma-1">
      <MudStack Spacing="0">
        <MudGrid Class="d-flex pa-2">
          <MudItem xs="10"
            Class="d-flex align-center justify-start"
            Style="font-size: large; font-weight: bold;">
            @Translate("Billing period"):
            @(analysis.StartOfMonth.Month + "/" + analysis.StartOfMonth.Year)
          </MudItem>
          <MudItem xs="2" Class="d-flex align-center justify-end">
            <MudIconButton
              Icon="@(Icons.Material.Filled.KeyboardArrowDown)"
              Color="Color.Default"/>
          </MudItem>
        </MudGrid>
        <MudCollapse Class="py-1" Expanded="true">
          <MudStack>
            <MudDivider DividerType="DividerType.Middle" Class="mt-2"/>
            <MudContainer>
              @Translate("First reading"):
              @(NumericString(analysis.Consumption.MinActiveEnergy_kWh, 0)) kWh
            </MudContainer>
            <MudContainer>
              @Translate("Last reading"):
              @(NumericString(analysis.Consumption.MaxActiveEnergy_kWh, 0)) kWh
            </MudContainer>
            <MudContainer Style="font-size: large; font-weight:bold;">
              @Translate("Total consumption"):
              @(NumericString(analysis.Consumption.ActiveEnergy_kWh, 0)) kWh
            </MudContainer>
            <MudContainer Style="font-weight:bold;">
              @Translate("Max power"):
              @(NumericString(analysis.MaxLoad.ActivePower_kW, 0)) kW
            </MudContainer>
          </MudStack>
        </MudCollapse>
      </MudStack>
    </MudPaper>
  }
</MudHidden>

<MudHidden Breakpoint="Breakpoint.SmAndDown">
  <MudDataGrid
    T="MonthlyAnalysis"
    MultiSelection="true"
    Items="@analysis.Analysis.Monthly"
    SortMode="SortMode.Multiple">
    <ToolBarContent>
      <MudText Typo="Typo.h4">
        @(Translate("Device") + ": " + Meter.Title + " (" + Meter.Id + ")")
      </MudText>
      <MudSpacer/>
      <MudTextField
        @bind-Value="_searchString"
        Placeholder="@Translate("Search")"
        Adornment="Adornment.Start"
        Immediate="true"
        AdornmentIcon="@Icons.Material.Filled.Search"
        IconSize="Size.Medium"
        Class="mt-0">
      </MudTextField>
    </ToolBarContent>
    <Columns>
      <PropertyColumn
        CellStyle="font-size: x-large;"
        Property="x => x.StartOfMonth"
        Title='@Translate("Billing period")'>
        <CellTemplate>
          @(context.Item.StartOfMonth.Month)/@(context.Item.StartOfMonth.Year)
        </CellTemplate>
      </PropertyColumn>
      <PropertyColumn
        CellStyle="font-size: x-large;"
        Property="x => x.Consumption.MinActiveEnergy_kWh"
        Title='@Translate("First reading")'>
        <CellTemplate>
          @(NumericString(context.Item.Consumption.MinActiveEnergy_kWh, 0)) kWh
        </CellTemplate>
      </PropertyColumn>
      <PropertyColumn
        CellStyle="font-size: x-large;"
        Property="x => x.Consumption.MaxActiveEnergy_kWh"
        Title='@Translate("Last reading")'>
        <CellTemplate>
          @(NumericString(context.Item.Consumption.MaxActiveEnergy_kWh, 0)) kWh
        </CellTemplate>
      </PropertyColumn>
      <PropertyColumn
        CellStyle="font-size: xx-large;"
        Property="x => x.Consumption.ActiveEnergy_kWh"
        Title='@Translate("Total consumption")'>
        <CellTemplate>
          @(NumericString(context.Item.Consumption.ActiveEnergy_kWh, 0)) kWh
        </CellTemplate>
      </PropertyColumn>
      <PropertyColumn
        CellStyle="font-size: x-large;"
        Property="x => x.MaxLoad.ActivePower_kW"
        Title='@Translate("Max power")'>
        <CellTemplate>
          @(NumericString(context.Item.MaxLoad.ActivePower_kW, 0)) kW
        </CellTemplate>
      </PropertyColumn>
    </Columns>
    <PagerContent>
      <MudDataGridPager T="MonthlyAnalysis"/>
    </PagerContent>
  </MudDataGrid>
</MudHidden>

@code {
  [CascadingParameter]
  public RepresentativeState RepresentativeState { get; set; } = default!;

  [Parameter]
  public IMeter Meter { get; set; } = default!;

  private string? _searchString;
}

<style>
  .mud-table-toolbar{ flex-wrap: wrap; height: inherit; }
</style>
