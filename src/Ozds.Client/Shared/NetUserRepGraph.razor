@using Ozds.Business.Time
@if (_graphValues is not null)
{
  @* MOBILE *@
  <MudHidden Breakpoint="Breakpoint.MdAndUp">
    <MudContainer Class="d-flex flex-column" MaxWidth="MaxWidth.Small">
      @if (_graphValues is not null)
      {
        <ApexChart TItem="ChartData"
                   XAxisType="XAxisType.Datetime"
                   Options="graphOptionsMob"
                   @ref="chart">
          <ApexPointSeries TItem="ChartData"
                           Items="@_graphValues"
                           Name="Potrošnja"
                           SeriesType="SeriesType.Area"
                           XValue='x => DateTimeGraph(x.date)'
                           YValue="x => x.value"/>
        </ApexChart>
      }
    </MudContainer>
  </MudHidden>


  @* DESKTOP *@
  <MudHidden Breakpoint="Breakpoint.SmAndDown">
    @if (_graphValues is not null)
    {
      <ApexChart TItem="ChartData"
                 XAxisType="XAxisType.Datetime"
                 Options="graphOptions"
                 @ref="chart">
        <ApexPointSeries TItem="ChartData"
                         Items="@_graphValues"
                         Name="Potrošnja"
                         SeriesType="SeriesType.Area"
                         XValue='x => DateTimeGraph(x.date)'
                         YValue="x => x.value"/>
      </ApexChart>
    }
  </MudHidden>
}


@code {
  [CascadingParameter] public UserState user { get; set; } = default!;
  [CascadingParameter] public RepresentativeState representative { get; set; } = default!;
  private ApexChartOptions<ChartData> graphOptions = new();
  private ApexChartOptions<ChartData> graphOptionsMob = new();
  public IEnumerable<ChartData> _graphValues = Enumerable.Empty<ChartData>();
  public List<ChartData> _totalConsumption = new();

  public record ChartData(decimal value, string name, DateTimeOffset date, string source);

  private ApexChart<ChartData> chart = default!;
  private readonly DateTimeOffset startOfThisYear = DateTimeOffset.UtcNow.GetStartOfYear();
  private readonly DateTimeOffset now = DateTime.UtcNow;
  private List<NetworkUserModel>? _netUsers;

  protected override async Task OnInitializedAsync()
  {
    var aggregateQueries = ScopedServices.GetRequiredService<OzdsAggregateQueries>();
    var query = ScopedServices.GetRequiredService<OzdsMeterTableQueries>();
    _netUsers = await query.GetNetworkUsersByRepresentative(representative.Representative);
    var quorterHourlyMeasures = await aggregateQueries.ReadAgnostic(new[] { "x => x.Interval == 0" }, startOfThisYear, now, 1, 9000);
    var values = quorterHourlyMeasures.OrderBy(x => x.Timestamp).GroupBy(x => x.Timestamp).ToList();
    foreach (var value in values)
    {
      var val = (decimal)value.FirstOrDefault()!.ActiveEnergySpan_Wh.SpanMax.TariffUnary.DuplexImport.PhaseSum;
      _graphValues = _graphValues.Append(new ChartData(val / 1000, "test", value.Key, "test"));
    }


    graphOptionsMob = NewApexChartOptions<ChartData>();
    graphOptionsMob.Grid = new Grid
    {
      BorderColor = "#e7e7e7",
      Row = new GridRow
      {
        Colors = new List<string> { "#f3f3f3", "transparent" },
        Opacity = 0.5d
      }
    };
    graphOptions = NewApexChartOptions<ChartData>();
    graphOptions.Grid = new Grid
    {
      BorderColor = "#e7e7e7",
      Row = new GridRow
      {
        Colors = new List<string> { "#f3f3f3", "transparent" },
        Opacity = 0.5d
      }
    };
    graphOptions.Chart = new Chart
    {
      Toolbar = new Toolbar
      {
        Tools = new Tools { Zoomin = false, Zoomout = false, Download = false, Pan = false, Selection = false }
      }
    };
    graphOptions.Tooltip = new Tooltip { X = new TooltipX { Format = @"dd. MM. yyyy." } };
    graphOptionsMob.Tooltip = new Tooltip { X = new TooltipX { Format = @"dd. MM. yyyy." } };
    graphOptionsMob.Yaxis = new List<YAxis>();
    graphOptions.Yaxis = new List<YAxis>();
    graphOptionsMob.Xaxis = new XAxis();

    graphOptionsMob.Yaxis.Add(new YAxis
    {
      Show = false,
      Labels = new YAxisLabels
      {
        Formatter = "function(val, index) { return val.toFixed(0);}"
      }
    });
    graphOptions.Yaxis.Add(new YAxis
    {
      Labels = new YAxisLabels
      {
        Formatter = "function(val, index) { return val.toFixed(0);}"
      }
    });
    graphOptionsMob.Xaxis = new XAxis
    {
      Labels = new XAxisLabels
      {
        Format = @"dd. MM."
      }
    };
    graphOptionsMob.Chart = new Chart
    {
      Toolbar = new Toolbar
      {
        Tools = new Tools { Zoomin = false, Zoomout = false, Download = false, Pan = false, Selection = false }
      }
    };
    graphOptions.Xaxis = new XAxis
    {
      Labels = new XAxisLabels
      {
        Format = @"dd. MM."
      }
    };
    graphOptions.Chart = new Chart
    {
      Toolbar = new Toolbar
      {
        Tools = new Tools { Zoomin = false, Zoomout = false, Download = false, Pan = false, Selection = false }
      }
    };
  }

}
