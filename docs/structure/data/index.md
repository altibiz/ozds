# [`Ozds.Data`](src/Ozds.Data)

This project contains all entities and queries for the database. The entities
are kept in the `Entities` namespace and queries are functions in the
`OzdsDbClient` class. The class is partial and it is divided into conceptually
similar files (ie. all queries for meters are in the OzdsDbClientMeters.cs
file).

## Schema

[The schema](docs/data/schema.md) is generated using `mermerd` when it is
migrated to the latest migration generated by `dotnet ef`.

## `Ozds.Data.Entities`

Contains entities that are used to represent tables in the database.

There are a couple of marker interfaces that are used to implement certain
functionality or interceptors in `Ozds.Business`:

- Readonly: marker interface used to implement read-only entities by throwing
  exceptions on mutations

```plantuml
interface IReadonly
```

- Aggregate: marker interface used to implement measurement aggregation. For now
  measurements are aggregated in quarter-hourly, daily and monthly intervals.

```plantuml
interface IReadonly

enum IntervalEntity
{
  QuarterHourly
  Daily
  Monthly
}

interface IAggregateEntity
{
  + DateTimeOffset Timestamp
  + long Count
  + IntervalEntity Interval
  + string MeterId
}

IReadonly <|-- IAggregateEntity
IAggregateEntity *-- IntervalEntity
```

- Measurement: marker interface used to implement aggregations over
  measurements.

```plantuml
interface IMeasurementEntity
{
  + DateTimeOffset Timestamp
  + string MeterId
}
```

Apart from the marker interfaces, entities can be grouped in a few class
hierarchies. These hierarchies make it easier to group entities that have
similar mapping to database tables:

- Auditable: entities that can be audited. These entities also have soft delete
  functionality implemented via interceptors.
